# Internal auth (Supervisor API)
NEXUS_API_KEY=dev-key

# Admin auth (DLQ ops)
ADMIN_API_KEY=admin-key

# Task store (Redis)
REDIS_URL=redis://redis:6379/0
TASK_TTL_SECONDS=604800

# Message Queue (RabbitMQ)
RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
TASK_QUEUE=nexus.tasks
RETRY_QUEUE_PREFIX=nexus.retry
DLQ_QUEUE=nexus.dlq
MAX_RETRIES=3

# Optional: enforce LLM key in production (recommended)
# Claude/Anthropic is supported in v2.2
LLM_PROVIDER=anthropic  # anthropic|zai|gemini|openai
LLM_REQUIRED=false

# Gemini (default)
GEMINI_API_KEY=YOUR_GEMINI_API_KEY
GEMINI_MODEL=gemini-3-flash-preview

# OpenAI (optional)
# OPENAI_API_KEY=YOUR_OPENAI_API_KEY
OPENAI_MODEL=gpt-5.2

# Optional: callback integrity
# CALLBACK_SIGNATURE_SECRET=change-me


# Claude (Anthropic) - recommended for coding
ANTHROPIC_API_KEY=YOUR_ANTHROPIC_API_KEY
ANTHROPIC_MODEL=claude-sonnet-4-5-20250929

# Optional fallbacks (comma-separated): e.g. gemini,openai
LLM_FALLBACKS=gemini,openai


# GLM-4.7 (Z.ai) - recommended alternative baseline
# API is OpenAI-compatible chat completions endpoint.
ZAI_API_KEY=YOUR_ZAI_API_KEY
ZAI_MODEL=glm-4.7
# Optional override if needed:
# ZAI_BASE_URL=https://api.z.ai/api/paas/v4/chat/completions


# Circuit breaker (provider health)
BREAKER_WINDOW_SECONDS=300
BREAKER_FAIL_THRESHOLD=5
BREAKER_COOLDOWN_SECONDS=120


# DLQ auto triage policy (comma-separated failure_code)
AUTO_REQUEUE_FAILURE_CODES=PROVIDER_TIMEOUT,PROVIDER_UPSTREAM_ERROR,PROVIDER_RATE_LIMIT
AUTO_HOLD_FAILURE_CODES=SCHEMA_PARSE_ERROR,SCHEMA_VALIDATION_ERROR,SCHEMA_REPAIR_FAILED
AUTO_ALARM_FAILURE_CODES=PROVIDER_AUTH_ERROR,PROVIDER_DISABLED


# Alerts (optional)
ALERT_WEBHOOK_URL=

# Hold queue
HOLD_QUEUE=nexus.hold

# Task lock (anti-infinite retry)
TASK_LOCK_TTL_SECONDS=900


# Alarm queue
ALARM_QUEUE=nexus.alarm
ENFORCE_ALARM_NO_REQUEUE=true

# Runbook base URL (optional)
RUNBOOK_BASE_URL=


# Alert dedupe (seconds)
ALERT_DEDUPE_TTL_SECONDS=900

# GitHub integration (optional)
GITHUB_API_BASE=https://api.github.com
GITHUB_REPO=
GITHUB_TOKEN=

# Alert routes (optional)
ALERT_WEBHOOK_URL_ALARM=
ALERT_WEBHOOK_URL_HOLD=


# DLQ apply age window
DLQ_APPLY_MAX_AGE_SECONDS=7200

# Example: RUNBOOK_BASE_URL=https://runbooks.internal/nexus


# GitHub PR automation (optional)
GITHUB_DEFAULT_BRANCH=
GITHUB_AUTOFIX_DIR=.nexus/autofix


# Autofix patch apply (advanced, risky; default false)
AUTOFIX_APPLY_PATCHES=false
AUTOFIX_PATCH_ALLOWLIST=shared/,nexus_supervisor/,docs/,openapi.yaml
AUTOFIX_PATCH_MAX_FILES=5
AUTOFIX_PATCH_MAX_LINES=400


# GitHub Actions CI dispatch (optional)
GITHUB_API_BASE=https://api.github.com
GITHUB_WORKFLOW=  # e.g. ci.yml or workflow id
GITHUB_WORKFLOW_REF=  # if empty, uses PR branch
GITHUB_ACTIONS_WAIT_SECONDS=60
GITHUB_ACTIONS_POLL_SECONDS=3


# AutoFix CI policy (optional)
AUTOFIX_CI_RETRY_ONCE=true
AUTOFIX_LABEL_READY=autofix-ready
AUTOFIX_LABEL_FAILED=autofix-failed
AUTOFIX_AUTO_MERGE=false
AUTOFIX_MERGE_METHOD=squash  # merge|squash|rebase
AUTOFIX_ASSIGNEES=  # comma-separated logins


# Merge hardening (optional)
AUTOFIX_REQUIRED_CHECKS=  # e.g. unit-tests,lint,openapi-contract


# v4.0 stability tuning (optional)
AUTOFIX_CHECK_MATCH_MODE=contains  # exact|contains|regex
AUTOFIX_MERGEABLE_POLL_SECONDS=6
AUTOFIX_MERGEABLE_MAX_WAIT_SECONDS=18
AUTOFIX_LABEL_CONFLICT=autofix-conflict
AUTOFIX_MENTION_ON_CONFLICT=  # e.g. @team-oncall


AUTOFIX_MERGEABLE_BACKOFF_CURVE=2,6,12


# v4.2 checks policy
AUTOFIX_CHECK_DUAL_SOURCE=true  # check-runs + status contexts
AUTOFIX_CHECK_ACCEPT_NEUTRAL=false
AUTOFIX_CHECK_ACCEPT_SKIPPED=false


# v4.3 per-check policy (optional, JSON)
# Example: {"unit-tests":{"allow":["success"]},"lint":{"allow":["success","skipped"]}}
AUTOFIX_REQUIRED_CHECKS_POLICY=


# v4.4 review/branch protection gating
AUTOFIX_USE_BRANCH_PROTECTION=false  # if true, fetch required status checks and approvals from branch protection (best-effort)
AUTOFIX_REQUIRE_APPROVALS=0          # used when AUTOFIX_USE_BRANCH_PROTECTION=false
AUTOFIX_LABEL_NEEDS_REVIEW=autofix-needs-review


# v4.5 merge strategy
AUTOFIX_MERGE_STRATEGY=direct     # direct (REST merge) | auto (enable GitHub auto-merge/queue)
AUTOFIX_AUTO_MERGE_FALLBACK=true  # if direct merge fails due to merge queue, try auto-merge
AUTOFIX_LABEL_QUEUED=autofix-queued


# v4.6 cooldown + labels
AUTOFIX_FAILURE_COOLDOWN_MINUTES=30
AUTOFIX_LABEL_NEED_PERMISSION=autofix-need-permission
AUTOFIX_LABEL_NEED_REBASE=autofix-need-rebase
AUTOFIX_LABEL_NEED_CHECKS=autofix-need-checks
AUTOFIX_LABEL_NEED_MERGE_QUEUE=autofix-need-merge-queue


# v4.7 persistent cooldown store (recommended for multi-worker/restarts)
AUTOFIX_COOLDOWN_STORE_PATH=/tmp/nexus_cooldown_store.json


# v4.8 cooldown key granularity + comment dedupe
AUTOFIX_COOLDOWN_KEY_MODE=repo_pr_class
AUTOFIX_COMMENT_DEDUPE=true


# v4.9 strict comment targeting
AUTOFIX_GITHUB_BOT_LOGIN=            # optional, e.g. nexus-bot or github-actions[bot]
AUTOFIX_COMMENT_MARKER="<!-- NEXUS_AUTOFIX_MARKER:v1 -->"


# v5.0 comment table + diff
AUTOFIX_COMMENT_DIFF_MAX_LINES=24
AUTOFIX_COMMENT_STORE_BODY=true
# Marker v2 should be left as default unless you want custom prefix.
AUTOFIX_COMMENT_MARKER="<!-- NEXUS_AUTOFIX_MARKER:v2 -->"


# v5.1 changelog summary (field delta)
AUTOFIX_COMMENT_CHANGELOG=true


# v5.2 transition summary header + next_actions delta
AUTOFIX_COMMENT_TRANSITION_SUMMARY=true


# v5.3 action delta + top blocker
AUTOFIX_COMMENT_ACTION_DELTA=true
AUTOFIX_COMMENT_TOP_BLOCKER=true


# v5.4 quick links + top blocker runbook link
AUTOFIX_COMMENT_TOP_BLOCKER_LINK=true
AUTOFIX_COMMENT_QUICKLINKS=true


# v5.5 failing check highlight + issue fallback
AUTOFIX_COMMENT_TOP_CHECK=true
AUTOFIX_COMMENT_ISSUE_FALLBACK=true


# v5.6: failure policy (retry/backoff) + issue append
AUTOFIX_COMMENT_ISSUE_APPEND=true
AUTOFIX_COMMENT_FAIL_RETRY=true
AUTOFIX_COMMENT_FAIL_RETRY_MAX=3
AUTOFIX_COMMENT_FAIL_RETRY_BASE_MS=600


# v5.7: update issue body to latest + respect Retry-After header
AUTOFIX_COMMENT_ISSUE_UPDATE_BODY=true
AUTOFIX_COMMENT_RESPECT_RETRY_AFTER=true


# v5.8 webhook fallback (Slack/Discord/Teams compatible simple JSON)
AUTOFIX_ALERT_WEBHOOK_ENABLED=false
AUTOFIX_ALERT_WEBHOOK_URL=


# v5.9 webhook: format + routing
# format: text | slack_blocks
AUTOFIX_ALERT_WEBHOOK_FORMAT=text
# route map (optional): "repo:org/repo=url;repo:org/repo2=url;default=url"
AUTOFIX_ALERT_WEBHOOK_ROUTE_MAP=


# v6.1: issue body history normalization
AUTOFIX_ISSUE_HISTORY_IN_BODY=true
AUTOFIX_ISSUE_HISTORY_MAX=10

# v6.1: webhook format extension
# format: text | slack_blocks | teams_adaptive
AUTOFIX_ALERT_WEBHOOK_FORMAT=text


# v6.3 API management (LLM)
LLM_PRIMARY_PROVIDER=gemini
LLM_FALLBACK_PROVIDERS=openai,anthropic,glm
LLM_REQUEST_TIMEOUT_S=60
LLM_MAX_RETRIES=2
LLM_RATE_LIMIT_RPM=60
LLM_BUDGET_DAILY_USD=20
LLM_BUDGET_SOFT_PCT=0.8
LLM_BUDGET_HARD_PCT=1.0
LLM_AUDIT_ENABLED=true
LLM_AUDIT_LOG_PATH=logs/llm_audit.jsonl

# LLM provider API keys (set in runtime secrets, not committed)
GEMINI_API_KEY=
OPENAI_API_KEY=
ANTHROPIC_API_KEY=
GLM_API_KEY=

# YouTube Data API (optional; enables youtube.search/play tool)
YOUTUBE_API_KEY=
YOUTUBE_DEFAULT_REGION=KR
YOUTUBE_DEFAULT_LANGUAGE=ko

# RAG auto-ingest (optional; scans a local mirror folder, default 03:00 KST)
RAG_AUTO_INGEST_ENABLED=false
RAG_AUTO_INGEST_PATH=/data/gdrive_mirror
RAG_AUTO_INGEST_EXTENSIONS=pdf,docx,pptx,xlsx,txt,md,hwp
RAG_AUTO_INGEST_ORG_ID=default
RAG_AUTO_INGEST_PROJECT_ID=nexus
RAG_AUTO_INGEST_HOUR=3
RAG_AUTO_INGEST_MINUTE=0
RAG_AUTO_INGEST_MAX_FILES=5000
RAG_AUTO_INGEST_MAX_FILE_MB=50


# SSE stream retention
STREAM_EVENT_KEEP=2000
STREAM_WORKLOG_KEEP=200


# v6.5 governance enhancements
LLM_RATE_LIMIT_RPM_GLOBAL=60
LLM_RATE_LIMIT_RPM_MAP=gemini:60,anthropic:30,openai:30,glm:30
LLM_SOFT_DEGRADE_MAX_OUTPUT_TOKENS=256
LLM_SOFT_DEGRADE_PREFER_CHEAPEST=true


# v6.6 FinOps + dedupe
LLM_COST_LEDGER_PATH=logs/llm_cost_ledger.jsonl
LLM_DEDUPE_ENABLED=true
LLM_DEDUPE_TTL_S=30


# v6.7 model-specific pricing + cache policies
# JSON string, provider defaults + optional model overrides (escape quotes in shell)
LLM_PRICING_JSON=
# purpose-based dedupe TTL map (seconds)
LLM_DEDUPE_TTL_MAP=default:30,ops:15,autofix:10


# v6.8 tagging defaults for dashboards / reports
LLM_DEFAULT_TEAM=default
LLM_DEFAULT_PROJECT=nexus


# v6.9 notifications + anomaly thresholds
SLACK_WEBHOOK_URL=
TEAMS_WEBHOOK_URL=
NOTIFY_PREFER=slack
ANOMALY_WINDOW_MIN=15
ANOMALY_COST_USD_RATE_THRESHOLD=2.0
ANOMALY_BREAKER_OPEN_MIN=5
ANOMALY_429_BURST_THRESHOLD=20
