openapi: 3.0.3
info:
  title: NEXUS Supervisor API
  version: "6.11.0"
servers:
  - url: http://localhost:8000
security:
  - ApiKeyAuth: []
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code: { type: string }
            message: { type: string }
            detail: { type: object, additionalProperties: true }
          required: [code, message]
      required: [error]
    TaskCreateRequest:
      type: object
      properties:
        requested_by: { type: string }
        payload: { type: object, additionalProperties: true }
      required: [requested_by, payload]
    TaskCreateResponse:
      type: object
      properties:
        task_id: { type: string }
        status: { type: string }
      required: [task_id, status]
    TaskStatusResponse:
      type: object
      properties:
        task_id: { type: string }
        task_type: { type: string }
        status: { type: string }
        requested_by: { type: string }
        requested_at: { type: string, format: date-time }
        finished_at: { type: string, format: date-time, nullable: true }
        result: { type: object, nullable: true, additionalProperties: true }
        error:
          type: object
          nullable: true
          properties:
            code: { type: string }
            message: { type: string }
            detail: { type: object, additionalProperties: true }
      required: [task_id, task_type, status, requested_by, requested_at]
    AgentCallbackRequest:
      type: object
      properties:
        task_id: { type: string }
        status: { type: string, enum: [succeeded, failed, running] }
        finished_at: { type: string, format: date-time }
        result: { type: object, additionalProperties: true }
        error:
          type: object
          properties:
            code: { type: string }
            message: { type: string }
            detail: { type: object, additionalProperties: true }
        metrics:
          type: object
          properties:
            duration_ms: { type: integer }
            retries: { type: integer }
      required: [task_id, status]
    LLMGenerateRequest:
      type: object
      properties:
        input: { type: string }
      required: [input]
    LLMGenerateResponse:
      type: object
      properties:
        provider: { type: string }
        model: { type: string }
        output_text: { type: string }
        disabled: { type: boolean }
      required: [provider, model, output_text, disabled]
paths:
  /health:
    get:
      summary: Health check
      responses:
        "200": { description: OK }
  /excel-kakao:
    post:
      summary: Create excel_kakao task
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/TaskCreateRequest" }
      responses:
        "200":
          description: Task created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/TaskCreateResponse" }
  /tasks/{task_id}:
    get:
      summary: Get task status/result
      parameters:
        - in: path
          name: task_id
          required: true
          schema: { type: string }
      responses:
        "200":
          description: Task status
          content:
            application/json:
              schema: { $ref: "#/components/schemas/TaskStatusResponse" }
  /agent/callback:
    post:
      summary: Agent callback (result update)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/AgentCallbackRequest" }
      responses:
        "200": { description: Updated }
  /llm/generate:
    post:
      summary: Generate text using configured LLM provider (Gemini default)
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/LLMGenerateRequest" }
      responses:
        "200":
          description: Generated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/LLMGenerateResponse" }

  /metrics:
    get:
      summary: Prometheus metrics
      responses:
        "200":
          description: OK

  /dlq/peek:
    get:
      summary: Peek DLQ messages (admin)
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
      responses:
        "200":
          description: OK

  /dlq/requeue:
    post:
      summary: Requeue DLQ messages (admin)
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
      responses:
        "200":
          description: OK

  /dlq/purge:
    post:
      summary: Purge DLQ messages (admin)
      parameters:
        - in: query
          name: limit
          schema:
            type: integer
      responses:
        "200":
          description: OK
