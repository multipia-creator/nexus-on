version: '3.9'
services:
  rabbitmq:
    image: rabbitmq:3-management
    ports:
    - 5672:5672
    - 15672:15672
    environment:
    - RABBITMQ_DEFAULT_USER=guest
    - RABBITMQ_DEFAULT_PASS=guest
    healthcheck:
      test:
      - CMD
      - rabbitmq-diagnostics
      - ping
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
    - rabbitmq_data:/var/lib/rabbitmq
  redis:
    image: redis:7-alpine
    ports:
    - 6379:6379
    command:
    - redis-server
    - --save
    - '60'
    - '1'
    - --loglevel
    - warning
    healthcheck:
      test:
      - CMD
      - redis-cli
      - ping
      interval: 10s
      timeout: 3s
      retries: 20
    volumes:
    - redis_data:/data
  supervisor:
    build: ../nexus_supervisor
    ports:
    - 8000:8000
    env_file:
    - ../.env
    environment:
    - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
    - TASK_QUEUE=nexus.tasks
    - REDIS_URL=redis://redis:6379/0
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test:
      - CMD
      - python
      - -c
      - import urllib.request; print(urllib.request.urlopen('http://localhost:8000/health').read().decode())
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
    - ../data:/data
  alarm_worker:
    build: ../nexus_supervisor
    env_file:
    - ../.env
    command:
    - python
    - -m
    - shared.alarm_worker
    environment:
    - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
    - ALARM_QUEUE=nexus.alarm
    - ALARM_RETRY_QUEUE_PREFIX=nexus.alarm.retry
    - ALARM_DLQ_QUEUE=nexus.alarm.dlq
    - ALARM_MAX_RETRIES=2
    - REDIS_URL=redis://redis:6379/0
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      supervisor:
        condition: service_healthy
    volumes:
    - ../data:/data
  agent_excel_kakao:
    build: ../agents/student
    env_file:
    - ../.env
    environment:
    - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
    - TASK_QUEUE=nexus.tasks
    - SUPERVISOR_URL=http://supervisor:8000
    depends_on:
      rabbitmq:
        condition: service_healthy
      redis:
        condition: service_healthy
      supervisor:
        condition: service_healthy
    volumes:
    - ../data:/data
volumes:
  rabbitmq_data: {}
  redis_data: {}
